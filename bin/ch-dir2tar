#!/bin/sh

LIBEXEC="$(cd "$(dirname "$0")" && pwd)"
. "${LIBEXEC}/base.sh"

# shellcheck disable=SC2034
usage=$(cat <<EOF
Pack a directory into a Charliecloud tarball.

Usage:

  $ $(basename "$0") DIR TARBALL 
EOF
)

parse_basic_args "$@"

if [ "$1" = --verbose ]; then
    verbose=yes
    shift
fi
if [ $# -lt 2 ]; then
    usage
fi
newroot=$1
tarball=$2

sentinel=WEIRD_AL_YANKOVIC

if [ ! -d "$newroot" ]; then
    echo "no such directory $newroot"
    exit 1
fi
if    [ ! -f "${newroot}/${sentinel}" ] \
   || [ ! -d "${newroot}/bin" ] \
   || [ ! -d "${newroot}/lib" ] \
   || [ ! -d "${newroot}/usr" ]; then
    echo "${newroot} exists but does not appear to be an image" 1>&2
    exit 1
fi
if [[ -f "$tarball" ]] || [[ -r "$tarball" ]]; then
    echo "replacing existing tarball $tarball"
fi
cd $newroot
tar czf "$tarball" .
echo "${tarball} packed ok"
